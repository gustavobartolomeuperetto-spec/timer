<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Timer SLA – 4 Chats (VBET)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --vbet-magenta: #e0007a;
      --vbet-magenta-light: #ff5fb3;
      --vbet-dark-bg: #050816;
      --vbet-card-dark: #0b1120;
      --vbet-card-border-dark: #1f2937;
      --vbet-light-bg: #f9fafb;
      --vbet-card-light: #ffffff;
      --vbet-card-border-light: #e5e7eb;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 10px;
    }

    body.theme-dark {
      background: var(--vbet-dark-bg);
      color: #e5e7eb;
    }

    body.theme-light {
      background: var(--vbet-light-bg);
      color: #111827;
    }

    h1 {
      font-size: 1.1rem;
      text-align: center;
      margin-bottom: 4px;
    }

    .clock {
      text-align: center;
      font-size: 0.95rem;
      font-weight: 600;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      font-size: 0.8rem;
    }

    .top-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .top-group label {
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    #volume {
      width: 100px;
    }

    select,
    input[type="range"] {
      cursor: pointer;
    }

    .test-btn,
    .theme-btn,
    .help-btn,
    .flow-help-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    body.theme-dark .theme-btn {
      background: #f9fafb;
      color: #111827;
    }

    body.theme-light .theme-btn {
      background: #111827;
      color: #f9fafb;
    }

    body.theme-dark .test-btn {
      background: #f97316;
      color: #111827;
    }

    body.theme-light .test-btn {
      background: #ea580c;
      color: #ffffff;
    }

    body.theme-dark .help-btn {
      background: #374151;
      color: #e5e7eb;
    }

    body.theme-light .help-btn {
      background: #d1d5db;
      color: #111827;
    }

    body.theme-dark .flow-help-btn {
      background: #1d4ed8;
      color: #e5e7eb;
    }

    body.theme-light .flow-help-btn {
      background: #3b82f6;
      color: #f9fafb;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    @media (min-width: 750px) {
      .grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .card {
      border-radius: 12px;
      padding: 10px;
      position: relative;
      transition: background 0.2s, box-shadow 0.2s, border-color 0.2s, transform 0.1s, opacity 0.1s;
    }

    body.theme-dark .card {
      background: var(--vbet-card-dark);
      border: 1px solid var(--vbet-card-border-dark);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    }

    body.theme-light .card {
      background: var(--vbet-card-light);
      border: 1px solid var(--vbet-card-border-light);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.15);
    }

    .card-title {
      font-size: 0.9rem;
      font-weight: 700;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .drag-hint {
      font-size: 0.65rem;
      opacity: 0.6;
    }

    body.theme-dark .card-title {
      color: #f9fafb;
    }

    body.theme-light .card-title {
      color: #111827;
    }

    .label-row,
    .time-input-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
    }

    .label-row span,
    .time-input-row span {
      font-size: 0.75rem;
      opacity: 0.75;
      white-space: nowrap;
    }

    .label-input,
    .time-input {
      flex: 1;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      font-size: 0.8rem;
    }

    body.theme-dark .label-input,
    body.theme-dark .time-input {
      background: #020617;
      color: #e5e7eb;
      border-color: #4b5563;
    }

    body.theme-light .label-input,
    body.theme-light .time-input {
      background: #f9fafb;
      color: #111827;
      border-color: #cbd5f5;
    }

    .time-input::placeholder {
      color: #6b7280;
    }

    .time-toggle-row {
      display: flex;
      justify-content: flex-end;
      font-size: 0.72rem;
      margin-top: -4px;
      margin-bottom: 4px;
    }

    .time-toggle-row label {
      display: flex;
      align-items: center;
      gap: 4px;
      opacity: 0.8;
      cursor: pointer;
    }

    .time-input.disabled-field {
      cursor: not-allowed;
    }

    body.theme-dark .time-input.disabled-field {
      background: #111827;
      color: #6b7280;
      border-color: #374151;
    }

    body.theme-light .time-input.disabled-field {
      background: #e5e7eb;
      color: #9ca3af;
      border-color: #d1d5db;
    }

    .btn-paste-time.disabled-btn {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .time {
      font-size: 2rem;
      font-weight: 800;
      text-align: center;
      margin: 4px 0;
    }

    .last-timer,
    .history-msg,
    .status-msg,
    .flow-msg {
      text-align: center;
      font-size: 0.8rem;
      min-height: 1em;
      opacity: 0.9;
    }

    .last-timer {
      font-weight: 600;
      margin-top: 2px;
    }

    body.theme-dark .last-timer {
      color: var(--vbet-magenta-light);
    }

    body.theme-light .last-timer {
      color: var(--vbet-magenta);
    }

    .history-msg {
      opacity: 0.9;
      font-size: 0.8rem;
      margin-top: 2px;
    }

    .history-current {
      font-weight: 700;
      text-decoration: underline;
      color: var(--vbet-magenta-light);
    }

    body.theme-light .history-current {
      color: var(--vbet-magenta);
    }

    .flow-msg {
      margin-top: 4px;
      min-height: 1.2em;
    }

    .btn-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    button {
      border-radius: 999px;
      border: none;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-time {
      flex: 1;
      padding: 6px;
    }

    /* cores botões de tempo */
    body.theme-dark .btn-1,
    body.theme-dark .btn-2 {
      background: #4b5563;
      color: #f9fafb;
    }

    body.theme-dark .btn-3,
    body.theme-dark .btn-5 {
      background: var(--vbet-magenta);
      color: #fdf2f8;
    }

    body.theme-light .btn-1,
    body.theme-light .btn-2 {
      background: #e5e7eb;
      color: #111827;
    }

    body.theme-light .btn-3,
    body.theme-light .btn-5 {
      background: var(--vbet-magenta);
      color: #fdf2f8;
    }

    .btn-cancel,
    .btn-mute {
      padding: 6px;
      flex: 0.9;
    }

    body.theme-dark .btn-cancel {
      background: #374151;
      color: #e5e7eb;
    }

    body.theme-light .btn-cancel {
      background: #e5e7eb;
      color: #111827;
    }

    body.theme-dark .btn-mute {
      background: #f97316;
      color: #111827;
    }

    body.theme-light .btn-mute {
      background: #ea580c;
      color: #ffffff;
    }

    .btn-paste-time {
      flex: 0 0 auto;
      padding: 4px 8px;
      font-size: 0.7rem;
    }

    body.theme-dark .btn-paste-time {
      background: #6b7280;
      color: #f9fafb;
    }

    body.theme-light .btn-paste-time {
      background: #d1d5db;
      color: #111827;
    }

    /* Botões de fluxo – agora com estilo uniforme (uma cor só) */
    .btn-flow {
      flex: 1;
      padding: 6px;
      font-size: 0.8rem;
      border: none;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
    }

    body.theme-dark .btn-flow {
      background: var(--vbet-magenta);
      color: #fdf2f8;
    }

    body.theme-light .btn-flow {
      background: var(--vbet-magenta);
      color: #ffffff;
    }

    .btn-flow-action,
    .btn-flow-ok,
    .btn-flow-noresp,
    .btn-flow-action-short {
      border: none !important;
    }

    /* Estados do card */
    .card.idle {}

    body.theme-dark .card.ok {
      background: radial-gradient(circle at top left, rgba(224, 0, 122, 0.2), var(--vbet-card-dark));
    }

    body.theme-light .card.ok {
      background: #ecfdf5;
      border-color: #6ee7b7;
    }

    body.theme-dark .card.warn {
      background: #78350f;
      border-color: #f59e0b;
    }

    body.theme-light .card.warn {
      background: #fffbeb;
      border-color: #f59e0b;
    }

    body.theme-dark .card.danger {
      background: #7f1d1d;
      border-color: #f97373;
    }

    body.theme-light .card.danger {
      background: #fef2f2;
      border-color: #f97373;
    }

    body.theme-dark .card.expired {
      background: #450a0a;
      box-shadow: 0 0 0 2px #fca5a5;
    }

    body.theme-light .card.expired {
      background: #fee2e2;
      box-shadow: 0 0 0 2px #f97373;
    }

    .blink {
      animation: blink 0.6s steps(1) infinite;
    }

    @keyframes blink {
      50% {
        opacity: 0.35;
      }
    }

    .suggested {
      box-shadow: 0 0 0 2px #fbbf24;
      transform: translateY(-1px);
    }

    .card.dragging {
      opacity: 0.7;
      transform: scale(0.98);
    }

    .card.drop-target {
      box-shadow: 0 0 0 2px var(--vbet-magenta);
    }

    .signature {
      position: fixed;
      bottom: 6px;
      right: 10px;
      font-size: 0.7rem;
      opacity: 0.6;
      pointer-events: none;
    }

    body.theme-dark .signature {
      color: #e5e7eb;
    }

    body.theme-light .signature {
      color: #4b5563;
    }

    /* Ajuda / modal */
    .help-modal,
    .flow-help-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .help-modal.open,
    .flow-help-modal.open {
      display: flex;
    }

    .help-content {
      max-width: 420px;
      width: 90%;
      border-radius: 12px;
      padding: 16px;
      font-size: 0.8rem;
    }

    body.theme-dark .help-content {
      background: #020617;
      color: #e5e7eb;
      box-shadow: 0 20px 35px rgba(0, 0, 0, 0.6);
    }

    body.theme-light .help-content {
      background: #ffffff;
      color: #111827;
      box-shadow: 0 20px 35px rgba(15, 23, 42, 0.25);
    }

    .help-title {
      font-size: 0.9rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .help-list {
      padding-left: 16px;
      margin: 0 0 8px 0;
    }

    .help-list li {
      margin-bottom: 4px;
    }

    .help-close {
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
    }

    body.theme-dark .help-close {
      background: #f97316;
      color: #111827;
    }

    body.theme-light .help-close {
      background: #111827;
      color: #f9fafb;
    }

    .flow-btn-small {
      margin-top: 4px;
      padding: 3px 8px;
      font-size: 0.7rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }

    body.theme-dark .flow-btn-small {
      background: #e5e7eb;
      color: #111827;
    }

    body.theme-light .flow-btn-small {
      background: #111827;
      color: #f9fafb;
    }
  </style>
</head>
<body class="theme-dark">
  <h1>Timer SLA – 4 Chats</h1>
  <div id="clock" class="clock">Horário atual (PC): --:--:--</div>

  <div class="top-bar">
    <div class="top-group">
      <label>
        Volume:
        <input id="volume" type="range" min="0" max="100" value="70">
        <span id="volume-value">70%</span>
      </label>
    </div>
    <div class="top-group">
      <label>
        Som:
        <select id="sound-type">
          <option value="single">Beep simples</option>
          <option value="triple" selected>Beep triplo</option>
          <option value="long">Beep longo</option>
        </select>
      </label>
    </div>
    <button class="test-btn" id="test-alarm">Testar alarme</button>
    <button class="theme-btn" id="theme-toggle">Modo claro</button>
    <button class="help-btn" id="help-btn">Ajuda geral</button>
    <button class="flow-help-btn" id="flow-help-btn">Ajuda fluxos</button>
  </div>

  <div class="grid">
    <div class="card idle" data-id="1" draggable="true">
      <div class="card-title">
        <span>Chat 1</span>
        <span class="drag-hint">Arraste para mover</span>
      </div>

      <div class="label-row">
        <span>Identificação:</span>
        <input class="label-input" placeholder="Identifique o cliente (nome ou assunto)">
      </div>
      <div class="time-input-row">
        <span>Hora msg:</span>
        <input class="time-input" placeholder="Campo opcional – use se quiser anotar um horário">
        <button class="btn-paste-time">Colar</button>
      </div>
      <div class="time-toggle-row">
        <label>
          <input type="checkbox" class="time-toggle">
          Usar horário do campo
        </label>
      </div>

      <div class="time">00:00</div>
      <div class="last-timer"></div>
      <div class="history-msg"></div>
      <div class="status-msg"></div>
      <div class="flow-msg"></div>

      <div class="btn-row">
        <button class="btn-time btn-1" data-minutes="1">+1</button>
        <button class="btn-time btn-2" data-minutes="2">+2</button>
        <button class="btn-time btn-3" data-minutes="3">+3</button>
        <button class="btn-time btn-5" data-minutes="5">+5</button>
        <button class="btn-flow btn-flow-action" data-flow="action">Ação 5-3-2-1</button>
        <button class="btn-flow btn-flow-action-short" data-flow="action_short">Ação 3-2-1</button>
        <button class="btn-flow btn-flow-ok" data-flow="after_ok">Fech. OK (1)</button>
        <button class="btn-flow btn-flow-noresp" data-flow="after_noresp">Fech. 2+1</button>
        <button class="btn-cancel">Cancelar</button>
        <button class="btn-mute">Silenciar</button>
      </div>
    </div>

    <div class="card idle" data-id="2" draggable="true">
      <div class="card-title">
        <span>Chat 2</span>
        <span class="drag-hint">Arraste para mover</span>
      </div>

      <div class="label-row">
        <span>Identificação:</span>
        <input class="label-input" placeholder="Identifique o cliente (nome ou assunto)">
      </div>
      <div class="time-input-row">
        <span>Hora msg:</span>
        <input class="time-input" placeholder="Campo opcional – use se quiser anotar um horário">
        <button class="btn-paste-time">Colar</button>
      </div>
      <div class="time-toggle-row">
        <label>
          <input type="checkbox" class="time-toggle">
          Usar horário do campo
        </label>
      </div>

      <div class="time">00:00</div>
      <div class="last-timer"></div>
      <div class="history-msg"></div>
      <div class="status-msg"></div>
      <div class="flow-msg"></div>

      <div class="btn-row">
        <button class="btn-time btn-1" data-minutes="1">+1</button>
        <button class="btn-time btn-2" data-minutes="2">+2</button>
        <button class="btn-time btn-3" data-minutes="3">+3</button>
        <button class="btn-time btn-5" data-minutes="5">+5</button>
        <button class="btn-flow btn-flow-action" data-flow="action">Ação 5-3-2-1</button>
        <button class="btn-flow btn-flow-action-short" data-flow="action_short">Ação 3-2-1</button>
        <button class="btn-flow btn-flow-ok" data-flow="after_ok">Fech. OK (1)</button>
        <button class="btn-flow btn-flow-noresp" data-flow="after_noresp">Fech. 2+1</button>
        <button class="btn-cancel">Cancelar</button>
        <button class="btn-mute">Silenciar</button>
      </div>
    </div>

    <div class="card idle" data-id="3" draggable="true">
      <div class="card-title">
        <span>Chat 3</span>
        <span class="drag-hint">Arraste para mover</span>
      </div>

      <div class="label-row">
        <span>Identificação:</span>
        <input class="label-input" placeholder="Identifique o cliente (nome ou assunto)">
      </div>
      <div class="time-input-row">
        <span>Hora msg:</span>
        <input class="time-input" placeholder="Campo opcional – use se quiser anotar um horário">
        <button class="btn-paste-time">Colar</button>
      </div>
      <div class="time-toggle-row">
        <label>
          <input type="checkbox" class="time-toggle">
          Usar horário do campo
        </label>
      </div>

      <div class="time">00:00</div>
      <div class="last-timer"></div>
      <div class="history-msg"></div>
      <div class="status-msg"></div>
      <div class="flow-msg"></div>

      <div class="btn-row">
        <button class="btn-time btn-1" data-minutes="1">+1</button>
        <button class="btn-time btn-2" data-minutes="2">+2</button>
        <button class="btn-time btn-3" data-minutes="3">+3</button>
        <button class="btn-time btn-5" data-minutes="5">+5</button>
        <button class="btn-flow btn-flow-action" data-flow="action">Ação 5-3-2-1</button>
        <button class="btn-flow btn-flow-action-short" data-flow="action_short">Ação 3-2-1</button>
        <button class="btn-flow btn-flow-ok" data-flow="after_ok">Fech. OK (1)</button>
        <button class="btn-flow btn-flow-noresp" data-flow="after_noresp">Fech. 2+1</button>
        <button class="btn-cancel">Cancelar</button>
        <button class="btn-mute">Silenciar</button>
      </div>
    </div>

    <div class="card idle" data-id="4" draggable="true">
      <div class="card-title">
        <span>Chat 4</span>
        <span class="drag-hint">Arraste para mover</span>
      </div>

      <div class="label-row">
        <span>Identificação:</span>
        <input class="label-input" placeholder="Identifique o cliente (nome ou assunto)">
      </div>
      <div class="time-input-row">
        <span>Hora msg:</span>
        <input class="time-input" placeholder="Campo opcional – use se quiser anotar um horário">
        <button class="btn-paste-time">Colar</button>
      </div>
      <div class="time-toggle-row">
        <label>
          <input type="checkbox" class="time-toggle">
          Usar horário do campo
        </label>
      </div>

      <div class="time">00:00</div>
      <div class="last-timer"></div>
      <div class="history-msg"></div>
      <div class="status-msg"></div>
      <div class="flow-msg"></div>

      <div class="btn-row">
        <button class="btn-time btn-1" data-minutes="1">+1</button>
        <button class="btn-time btn-2" data-minutes="2">+2</button>
        <button class="btn-time btn-3" data-minutes="3">+3</button>
        <button class="btn-time btn-5" data-minutes="5">+5</button>
        <button class="btn-flow btn-flow-action" data-flow="action">Ação 5-3-2-1</button>
        <button class="btn-flow btn-flow-action-short" data-flow="action_short">Ação 3-2-1</button>
        <button class="btn-flow btn-flow-ok" data-flow="after_ok">Fech. OK (1)</button>
        <button class="btn-flow btn-flow-noresp" data-flow="after_noresp">Fech. 2+1</button>
        <button class="btn-cancel">Cancelar</button>
        <button class="btn-mute">Silenciar</button>
      </div>
    </div>
  </div>

  <div class="signature">By: Bartolomeu & GPT</div>
  <div id="help-modal" class="help-modal">
    <div class="help-content">
      <div class="help-title">Ajuda geral</div>
      <ul class="help-list">
        <li>Cada card representa um chat diferente.</li>
        <li>Em <b>Identificação</b>, coloque o nome do cliente ou o assunto (ex: GUILHERME / SAQUE).</li>
        <li>O campo <b>Hora msg</b> é opcional; para que ele conte no timer, ative “Usar horário do campo”.</li>
        <li>Botões <b>+1, +2, +3, +5</b> iniciam um hold manual.</li>
        <li>Se “Usar horário do campo” estiver ligado, o hold conta a partir do horário digitado; caso contrário, conta a partir de agora.</li>
        <li>Os botões de fluxo (como <b>Ação 5-3-2-1</b>, <b>Ação 3-2-1</b>, etc.) seguem fluxos de inatividade específicos (veja em “Ajuda fluxos”).</li>
        <li>Quando o tempo zera, o card fica vermelho e o alarme toca até clicar em <b>Silenciar</b>.</li>
        <li><b>Cancelar</b> limpa o timer daquele chat, mas mantém o histórico de holds.</li>
        <li><b>Arraste</b> um card para trocar a posição dele com outro.</li>
      </ul>
      <button id="help-close" class="help-close">Fechar</button>
    </div>
  </div>

  <div id="flow-help-modal" class="flow-help-modal">
    <div class="help-content">
      <div class="help-title">Ajuda – fluxos de inatividade</div>
      <ul class="help-list">
        <li><b>Ação 5-3-2-1</b>: Cliente executando um passo a passo mais longo.</li>
        <li>Fluxo: 5 min → 3 min → 2 min → 1 min.</li>
        <li><b>Ação 3-2-1</b>: Cliente executando um passo a passo mais curto.</li>
        <li>Fluxo: **3 min → 2 min → 1 min**.</li>
        <li>**Regra para "Ação" (5-3-2-1 e 3-2-1):** O primeiro hold pode usar o horário do campo (se “Usar horário do campo” estiver ligado). Os próximos holds sempre começam quando você clica em "Já respondi, iniciar X min".</li>
        <li><b>Fech. OK (1)</b>: Após o cliente confirmar que ficou tudo certo (“ok”, “tudo certo”).</li>
        <li>Você pergunta se pode ajudar em algo mais, inicia o fluxo, e o timer segura **1 minuto** (usando o horário do campo se o modo estiver ligado, senão a partir de agora).</li>
        <li><b>Fech. 2+1</b>: Após enviar a resolutiva quando o cliente não responde.</li>
        <li>Primeiro hold de **2 minutos** (podendo usar o horário do campo); ao acabar, você envia “Posso ajudar em algo mais?” e o timer faz o segundo hold de **1 minuto** a partir do clique.</li>
      </ul>
      <button id="flow-help-close" class="help-close">Fechar</button>
    </div>
  </div>

  <script>
    const timers = {};
    let audioCtx = null;
    let alarmVolume = 0.7; // 0 a 1
    let soundType = 'triple';

    const volumeSlider = document.getElementById('volume');
    const volumeValue = document.getElementById('volume-value');
    const soundSelect = document.getElementById('sound-type');
    const testBtn = document.getElementById('test-alarm');
    const themeToggle = document.getElementById('theme-toggle');
    const clockEl = document.getElementById('clock');
    const helpBtn = document.getElementById('help-btn');
    const helpModal = document.getElementById('help-modal');
    const helpClose = document.getElementById('help-close');
    const flowHelpBtn = document.getElementById('flow-help-btn');
    const flowHelpModal = document.getElementById('flow-help-modal');
    const flowHelpClose = document.getElementById('flow-help-close');

    // ====== RELÓGIO (HORÁRIO DO PC) ======
    function updateClock() {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      const ss = String(now.getSeconds()).padStart(2, "0");
      clockEl.textContent = `Horário atual (PC): ${hh}:${mm}:${ss}`;
    }
    updateClock();
    setInterval(updateClock, 1000);

    // ====== AJUDA ======
    helpBtn.addEventListener('click', () => {
      helpModal.classList.add('open');
    });

    helpClose.addEventListener('click', () => {
      helpModal.classList.remove('open');
    });

    helpModal.addEventListener('click', (e) => {
      if (e.target === helpModal) {
        helpModal.classList.remove('open');
      }
    });

    flowHelpBtn.addEventListener('click', () => {
      flowHelpModal.classList.add('open');
    });

    flowHelpClose.addEventListener('click', () => {
      flowHelpModal.classList.remove('open');
    });

    flowHelpModal.addEventListener('click', (e) => {
      if (e.target === flowHelpModal) {
        flowHelpModal.classList.remove('open');
      }
    });

    // ====== TEMA (DIA/NOITE) ======
    function applyTheme(theme) {
      document.body.classList.remove('theme-dark', 'theme-light');
      document.body.classList.add(theme === 'light' ? 'theme-light' : 'theme-dark');
      if (theme === 'light') {
        themeToggle.textContent = 'Modo escuro';
      } else {
        themeToggle.textContent = 'Modo claro';
      }
      localStorage.setItem('timer_vbet_theme', theme);
    }

    const savedTheme = localStorage.getItem('timer_vbet_theme') || 'dark';
    applyTheme(savedTheme);

    themeToggle.addEventListener('click', () => {
      const current = document.body.classList.contains('theme-light') ? 'light' : 'dark';
      applyTheme(current === 'light' ? 'dark' : 'light');
    });

    // ====== CONTROLES DE ÁUDIO ======
    volumeSlider.addEventListener('input', () => {
      alarmVolume = Number(volumeSlider.value) / 100;
      volumeValue.textContent = volumeSlider.value + '%';
    });

    soundSelect.addEventListener('change', () => {
      soundType = soundSelect.value;
    });

    function ensureAudioCtx() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
    }

    function playBeepOnce(freq = 1100, duration = 0.35) {
      ensureAudioCtx();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "square";
      osc.frequency.value = freq;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      gain.gain.setValueAtTime(alarmVolume, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
      osc.start(now);
      osc.stop(now + duration);
    }

    function playAlarmPattern() {
      if (soundType === 'single') {
        playBeepOnce();
      } else if (soundType === 'triple') {
        playBeepOnce();
        setTimeout(() => playBeepOnce(), 250);
        setTimeout(() => playBeepOnce(), 500);
      } else if (soundType === 'long') {
        playBeepOnce(900, 0.7);
      }
    }

    testBtn.addEventListener('click', () => {
      playAlarmPattern();
    });

    // ====== UTILITÁRIOS DE TEMPO (CORRIGIDO PARA AM/PM) ======
    function formatTime(ms) {
      if (ms < 0) ms = 0;
      const totalSec = Math.floor(ms / 1000);
      const m = String(Math.floor(totalSec / 60)).padStart(2, "0");
      const s = String(totalSec % 60).padStart(2, "0");
      return `${m}:${s}`;
    }

    function extractTimeString(str) {
      if (!str) return null;
      // Expressão atualizada para capturar o horário E o AM/PM para o rótulo
      const match = str.trim().match(/(\d{1,2}:\d{2}(?::\d{2})?\s*(?:am|pm)?)/i);
      return match ? match[1] : null;
    }

    function parseTimeInputToTodayMillis(str) {
      if (!str) return null;
      
      // Expressão regular para capturar HH:MM(:SS) e opcionalmente AM/PM
      const match = str.trim().match(/(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(am|pm)?/i);
      
      if (!match) return null;
      
      let h = Number(match[1]);
      const m = Number(match[2]);
      const s = match[3] ? Number(match[3]) : 0;
      const period = match[4] ? match[4].toLowerCase() : null; // 'am', 'pm' ou null

      // Validação básica de minutos e segundos
      if (
        Number.isNaN(h) || Number.isNaN(m) || Number.isNaN(s) ||
        m < 0 || m > 59 || s < 0 || s > 59
      ) {
        return null;
      }

      // Lógica de conversão AM/PM para 24h
      if (period === 'pm' && h < 12) {
        // Se for PM e a hora for menor que 12 (ex: 3 PM), adiciona 12h
        h += 12;
      } else if (period === 'am' && h === 12) {
        // Se for 12 AM (meia-noite), a hora é 0
        h = 0;
      } else if (h === 24) {
        // Se a entrada for 24:XX (excedente), ajusta para 00:XX (meia-noite)
        h = 0;
      } else if (h < 0 || h > 23) {
        // Validação final da hora (após conversão AM/PM, se houver)
        return null;
      }

      const now = new Date();
      // Cria o objeto Date para o dia de hoje com as horas, minutos e segundos ajustados
      const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, s);
      
      return d.getTime();
    }
    
    function clearCardState(card) {
      card.classList.remove("ok", "warn", "danger", "expired", "blink");
      card.classList.add("idle");
      card.querySelector(".time").textContent = "00:00";
      card.querySelector(".status-msg").textContent = "";
      card.querySelector(".flow-msg").textContent = "";
    }

    function stopAlarm(id) {
      const t = timers[id];
      if (!t) return;
      if (t.alarmInterval) {
        clearInterval(t.alarmInterval);
        t.alarmInterval = null;
      }
      t.manualMuted = true; // não religar sozinho
    }

    function startAlarm(id) {
      const t = timers[id];
      if (!t || t.manualMuted) return;
      if (t.alarmInterval) return;
      playAlarmPattern();
      t.alarmInterval = setInterval(() => {
        if (!t.manualMuted) {
          playAlarmPattern();
        }
      }, 1500);
    }

    function updateHistoryDisplay(card, historyArr, currentMinutes) {
      const historyEl = card.querySelector(".history-msg");
      if (!historyArr || historyArr.length === 0) {
        historyEl.textContent = "";
        return;
      }
      const parts = historyArr.map((h, idx) => {
        const txt = `+${h.minutes}`;
        if (currentMinutes && h.minutes === currentMinutes && idx === historyArr.length - 1) {
          return `<span class="history-current">${txt}</span>`;
        }
        return txt;
      });
      historyEl.innerHTML = `Histórico de timers: ${parts.join(" → ")}`;
    }

    function updateLastTimerDisplay(card, minutes, baseLabel) {
      const lastEl = card.querySelector(".last-timer");
      if (!minutes) {
        lastEl.textContent = "";
        return;
      }
      const baseText = baseLabel || "a partir de agora";
      lastEl.textContent = `Último timer: +${minutes} min (${baseText})`;
    }

    function highlightLastButton(card, lastMinutes) {
      const btns = card.querySelectorAll(".btn-time");
      btns.forEach(b => b.classList.remove("suggested"));
      if (!lastMinutes) return;
      const btn = card.querySelector(`.btn-time[data-minutes="${lastMinutes}"]`);
      if (btn) btn.classList.add("suggested");
    }

    function setFlowMessage(card, html) {
      const el = card.querySelector(".flow-msg");
      el.innerHTML = html || "";
    }

    function setTimeFieldEnabled(card, enabled) {
      const timeInput = card.querySelector(".time-input");
      const btnPaste = card.querySelector(".btn-paste-time");
      timeInput.disabled = !enabled;
      if (!enabled) {
        timeInput.classList.add("disabled-field");
      } else {
        timeInput.classList.remove("disabled-field");
      }
      if (btnPaste) {
        btnPaste.disabled = !enabled;
        if (!enabled) {
          btnPaste.classList.add("disabled-btn");
        } else {
          btnPaste.classList.remove("disabled-btn");
        }
      }
    }

    function startTimer(card, minutes, options = {}) {
      const id = card.dataset.id;
      const prev = timers[id];
      const prevHistory = prev?.history || [];

      if (prev?.interval) {
        clearInterval(prev.interval);
      }
      if (prev) {
        stopAlarm(id);
      }

      const timeInput = card.querySelector(".time-input");
      const useFieldBase = options.useFieldBase === true;

      let baseTime = Date.now();
      let baseLabel = null;

      if (useFieldBase) {
        const raw = timeInput.value.trim();
        const cleaned = extractTimeString(raw);
        const parsed = parseTimeInputToTodayMillis(raw);
        if (parsed !== null && cleaned) {
          baseTime = parsed;
          baseLabel = `a partir de ${cleaned}`;
        }
      }

      const endTime = baseTime + minutes * 60 * 1000;
      const startNow = Date.now();

      const newHistory = [...prevHistory, {
        minutes,
        baseTime,
        startedAt: startNow
      }];
      const trimmedHistory = newHistory.slice(-4);

      timers[id] = {
        endTime,
        interval: null,
        expiredNotified: false,
        alarmInterval: null,
        history: trimmedHistory,
        lastMinutes: minutes,
        manualMuted: false,
        inactivityStep: options.inactivityStep ?? 0,
        flowType: options.flowType || null,
        awaitingFlowConfirm: false,
        currentMinutes: minutes
      };
      card.classList.remove("idle", "warn", "danger", "expired", "blink");
      card.classList.add("ok");

      const status = card.querySelector(".status-msg");
      status.textContent = ""; // sem texto extra
      setFlowMessage(card, "");
      updateLastTimerDisplay(card, minutes, baseLabel);
      updateHistoryDisplay(card, trimmedHistory, minutes);
      highlightLastButton(card, minutes);

      timers[id].interval = setInterval(() => {
        const t = timers[id];
        if (!t) return;
        const diff = t.endTime - Date.now();
        const timeEl = card.querySelector(".time");
        timeEl.textContent = formatTime(diff);

        const statusNow = card.querySelector(".status-msg");
        card.classList.remove("ok", "warn", "danger", "expired", "blink");

        if (diff > 60_000) {
          card.classList.add("ok");
          statusNow.textContent = "";
        } else if (diff > 15_000) {
          card.classList.add("warn");
          statusNow.textContent = "";
        } else if (diff > 0) {
          card.classList.add("danger", "blink");
          statusNow.textContent = "";
        } else {
          card.classList.add("expired");
          timeEl.textContent = "00:00";
          statusNow.textContent = "TEMPO ESGOTADO – responda e depois silencie o alarme";
          if (!t.expiredNotified && !t.manualMuted) {
            t.expiredNotified = true;
            startAlarm(id);
          }
          handleFlowOnExpire(card, id); // trata fluxos de inatividade
        }
      }, 200);
    }

    function cancelTimer(card) {
      const id = card.dataset.id;
      const t = timers[id];
      if (t?.interval) {
        clearInterval(t.interval);
      }
      if (t) {
        stopAlarm(id);
      }
      timers[id] = {
        history: t?.history || [],
        lastMinutes: null,
        manualMuted: false,
        expiredNotified: false,
        alarmInterval: null,
        interval: null,
        inactivityStep: 0,
        flowType: null,
        awaitingFlowConfirm: false,
        currentMinutes: null
      };
      clearCardState(card);
      updateLastTimerDisplay(card, null, null);
      updateHistoryDisplay(card, timers[id].history, null);
      highlightLastButton(card, null);
    }

    // ====== FLUXOS DE INATIVIDADE (ATUALIZADO) ======
    const FLOW_SEQUENCES = {
      action: [5, 3, 2, 1],       // cliente em ação (longo)
      action_short: [3, 2, 1],    // NOVO: cliente em ação (curto)
      after_ok: [1],              // pós-resolutiva com OK
      after_noresp: [2, 1]        // pós-resolutiva sem resposta
    };

    function startFlowStep(card, flowType, step, opts = {}) {
      const id = card.dataset.id;
      const seq = FLOW_SEQUENCES[flowType] || [];
      const minutes = seq[Math.min(step, seq.length - 1)] || 1;
      const useFieldBase = !!opts.useFieldBase;
      startTimer(card, minutes, {
        flowType,
        inactivityStep: step,
        useFieldBase
      });
      if (timers[id]) {
        timers[id].currentMinutes = minutes;
        timers[id].flowType = flowType;
        timers[id].inactivityStep = step;
        timers[id].awaitingFlowConfirm = false;
      }
    }

    // ATUALIZADO para incluir o fluxo action_short
    function handleFlowOnExpire(card, id) {
      const t = timers[id];
      if (!t || !t.flowType) return;
      const flowType = t.flowType;
      const step = t.inactivityStep || 0;
      const seq = FLOW_SEQUENCES[flowType] || [];
      const flowEl = card.querySelector(".flow-msg");
      
      const isActionFlow = flowType === 'action' || flowType === 'action_short';

      if (isActionFlow) {
        const flowName = flowType === 'action' ? '5-3-2-1' : '3-2-1';
        if (step < seq.length - 1) {
          if (!t.awaitingFlowConfirm) {
            t.awaitingFlowConfirm = true;
            const nextStep = step + 1;
            const currentMin = seq[step];
            const nextMin = seq[nextStep];
            flowEl.innerHTML = `
              Hold de ${currentMin} min terminou.<br>
              Você já respondeu o cliente para continuar o procedimento?<br>
              <button class="flow-btn-small" data-flow-confirm="yes" data-next-step="${nextStep}">Já respondi, iniciar ${nextMin} min</button>
              <button class="flow-btn-small" data-flow-confirm="no">Ainda não</button>
            `;
          }
        } else {
          flowEl.innerHTML = `Fluxo ${flowName} concluído. Se o cliente não respondeu, você pode encerrar o chat.`;
          t.flowType = null;
          t.awaitingFlowConfirm = false;
        }
      } else if (flowType === 'after_noresp') {
        if (step === 0) {
          if (!t.awaitingFlowConfirm) {
            t.awaitingFlowConfirm = true;
            flowEl.innerHTML = `
              Hold de 2 min terminou.<br>
              Você já enviou "Posso ajudar em algo mais?" ao cliente?<br>
              <button class="flow-btn-small" data-flow-confirm="yes" data-next-step="1">Já enviei, iniciar 1 min</button>
              <button class="flow-btn-small" data-flow-confirm="no">Ainda não</button>
            `;
          }
        } else {
          flowEl.innerHTML = `Fluxo 2 + 1 concluído. Se o cliente não respondeu, você pode encerrar o chat.`;
          t.flowType = null;
          t.awaitingFlowConfirm = false;
        }
      } else if (flowType === 'after_ok') {
        flowEl.innerHTML = `Hold final de 1 minuto concluído. Se o cliente não pediu mais nada, você pode encerrar o chat.`;
        t.flowType = null;
        t.awaitingFlowConfirm = false;
      }
    }

    function handleFlowButtonClick(card, flowType) {
      const id = card.dataset.id;
      timers[id] = timers[id] || {};
      const fieldToggle = card.querySelector(".time-toggle");
      const useFieldBase = fieldToggle && fieldToggle.checked;
      const step = 0;
      startFlowStep(card, flowType, step, {
        useFieldBase
      });
      setFlowMessage(card, "Fluxo de inatividade iniciado. O próximo passo depende da sua interação com o cliente.");
    }

    // ====== INICIALIZAÇÃO DOS CARDS ======
    document.querySelectorAll(".card").forEach(card => {
      const id = card.dataset.id;
      const btnTimeAll = card.querySelectorAll(".btn-time");
      const btnCancel = card.querySelector(".btn-cancel");
      const btnMute = card.querySelector(".btn-mute");
      const btnPasteTime = card.querySelector(".btn-paste-time");
      const labelInput = card.querySelector(".label-input");
      const timeInput = card.querySelector(".time-input");
      const flowBtns = card.querySelectorAll(".btn-flow");
      const flowMsg = card.querySelector(".flow-msg");
      const fieldToggle = card.querySelector(".time-toggle");

      labelInput.addEventListener("focus", (e) => e.target.select());
      timeInput.addEventListener("focus", (e) => e.target.select());

      // estado inicial: campo desativado
      setTimeFieldEnabled(card, fieldToggle.checked);

      fieldToggle.addEventListener("change", () => {
        setTimeFieldEnabled(card, fieldToggle.checked);
      });

      btnTimeAll.forEach(btn => {
        btn.addEventListener("click", () => {
          const minutes = Number(btn.dataset.minutes);
          const useFieldBase = fieldToggle && fieldToggle.checked;
          startTimer(card, minutes, {
            useFieldBase
          });
          if (timers[id]) {
            timers[id].flowType = null;
            timers[id].inactivityStep = 0;
          }
        });
      });

      flowBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          const flowType = btn.dataset.flow;
          handleFlowButtonClick(card, flowType);
        });
      });

      flowMsg.addEventListener("click", (e) => {
        const target = e.target;
        if (target.matches(".flow-btn-small")) {
          const confirm = target.dataset.flowConfirm;
          if (confirm === "yes") {
            const nextStep = Number(target.dataset.nextStep || 0);
            const t = timers[id];
            if (!t || !t.flowType) return;
            // próximos passos sempre a partir de agora
            startFlowStep(card, t.flowType, nextStep, {
              useFieldBase: false
            });
            setFlowMessage(card, "Próximo hold iniciado a partir da sua última resposta.");
          } else {
            setFlowMessage(card, "Quando você responder o cliente, clique no botão para iniciar o próximo hold.");
          }
        }
      });

      btnCancel.addEventListener("click", () => {
        cancelTimer(card);
      });

      btnMute.addEventListener("click", () => {
        stopAlarm(id);
        const status = card.querySelector(".status-msg");
        if (card.classList.contains("expired")) {
          status.textContent = "Tempo esgotado (alarme silenciado)";
        }
      });

      btnPasteTime.addEventListener("click", async () => {
        if (btnPasteTime.disabled) return;
        try {
          if (navigator.clipboard && navigator.clipboard.readText) {
            const txt = (await navigator.clipboard.readText() || "").trim();
            if (txt) {
              timeInput.value = txt;
              timeInput.focus();
              timeInput.select();
            } else {
              alert("Clipboard vazio. Copie a informação desejada primeiro.");
            }
          } else {
            alert("Seu navegador não permite ler o clipboard automaticamente. Cole manualmente (Ctrl+V).");
          }
        } catch (e) {
          console.log(e);
          alert("Não consegui ler o clipboard. Cole manualmente (Ctrl+V).");
        }
      });
    });

    // ====== DRAG & DROP PARA REORDENAR CARDS ======
    const cards = document.querySelectorAll(".card");

    cards.forEach(card => {
      card.addEventListener("dragstart", (e) => {
        card.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", card.dataset.id);
      });

      card.addEventListener("dragend", () => {
        card.classList.remove("dragging");
        card.classList.remove("drop-target");
      });

      card.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      });

      card.addEventListener("dragenter", (e) => {
        e.preventDefault();
        card.classList.add("drop-target");
      });

      card.addEventListener("dragleave", () => {
        card.classList.remove("drop-target");
      });

      card.addEventListener("drop", (e) => {
        e.preventDefault();
        card.classList.remove("drop-target");
        const sourceId = e.dataTransfer.getData("text/plain");
        if (!sourceId) return;
        const srcCard = document.querySelector(`.card[data-id="${sourceId}"]`);
        const tgtCard = card;
        if (!srcCard || srcCard === tgtCard) return;

        const grid = tgtCard.parentElement;
        const srcNext = srcCard.nextSibling === tgtCard ? srcCard : srcCard.nextSibling;
        grid.insertBefore(srcCard, tgtCard);
        grid.insertBefore(tgtCard, srcNext);
      });
    });
  </script>
</body>
</html>
